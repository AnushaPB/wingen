---
title: "sims"
output: html_document
---
 
```{r}
library(wingen)
library(raster)
library(vcfR)
library(viridis)
library(foreach)
library(doParallel)
library(here)
library(ggplot2)
library(dplyr)

library(adegenet)
library(hierfstat)
source("sim_functions.R")
```


# system time sims
```{r}
vcf <- read.vcfR("data/mod-sim_params_it-0_t-500_spp-spp_0.vcf")
geo <- read.csv("data/mod-sim_params_it-0_t-500_spp-spp_0.csv")
coords <- geo[,c("idx","x","y")]

set.seed(42)
l <- sample(nrow(vcf@gt), 10000)
si <- sample(nrow(coords), 200)
#write.csv( data.frame(loci = l, inds = si), "samples_seed42.csv", row.names = FALSE)

subvcf <- vcf[l,c(1, si+1)]

subcoords <- coords[si,]
subcoords <- subcoords[,c("x","y")]
subcoords$y <- -subcoords$y
coords$y <- -coords$y

# check match
all(colnames(subvcf@gt)[-1] == geo$idx[si])

```

```{r,  fig.width = 6, fig.height = 6}
lyr <- read.csv("data/middle_earth.csv", header = FALSE)
lyr <- raster(as.matrix(lyr))
extent(lyr) <- extent(0,100,-100,0)

kde <- raster(MASS::kde2d(coords$x, coords$y, h = c(10,10), n = 100, lims = c(0,100,-100,0)))

par(mar = rep(2,4))
plot(lyr, col = viridis::magma(100), main = "Carrying Capacity", axes = FALSE, box = FALSE)
plot(kde, col = viridis::magma(100), main = "Population Density", axes = FALSE, box = FALSE)
plot(lyr, col = mako(1, begin = 0.1, alpha = 0.1), main = "Distribution of Individuals", axes = FALSE, box = FALSE, zlim = c(0.01,1), legend = FALSE)
points(coords$x, coords$y, pch = 16, cex = 1, col = mako(1, begin = 0.7, alpha = 0.6), xlab = "", ylab = "")
points(subcoords$x, subcoords$y, pch = 16, cex = 1, col = mako(1, begin = 0.2, alpha = 0.9), xlab = "", ylab = "")
legend(0,-80, 
       c("All Individuals", "Sampled Individuals"), 
       pch = c(16,16), 
       col = c(mako(1, begin = 0.7), mako(1, begin = 0.2)),
       bty = "n",
       text.col = "black",
       cex = 1.5)

```


```{r, fig.width = 6, fig.height = 6}

tr <- sim(subvcf, subcoords, lyr, stat = "pi", fact = 3, wdim = 5, min_n = 4, rarify = TRUE, parallel = TRUE, nloci = nrow(subvcf@gt))

tr_k <- krig_gd(tr[["res"]], lyr)
tr_k_mask <- mask_gd(tr_k, 4)

par(mar = rep(0,4), oma = rep(0,4), pty = "s")
plot(lyr, col = magma(1, begin = 0.1, alpha = 0.1), axes = FALSE, box = FALSE, zlim = c(0.01,1), legend = FALSE)
plot(tr[["res"]]$pi, col = viridis::magma(100, alpha = 1.0), main = "Window Pi", axes = FALSE, box = TRUE, legend = TRUE, add = TRUE)

plot(lyr, col = magma(1, begin = 0.1, alpha = 0.1), axes = FALSE, box = FALSE, zlim = c(0.01,1), legend = FALSE)
plot(tr_k$pi, col = viridis::magma(100), main = "Masked Pi", axes = FALSE, box = TRUE, legend = FALSE, add = TRUE)

plot(lyr, col = magma(1, begin = 0.1, alpha = 0.1), axes = FALSE, box = FALSE, zlim = c(0.01,1), legend = FALSE)
plot(tr_k_mask, col = viridis::magma(100), main = "Kriged and Masked Pi", axes = FALSE, box = TRUE, legend = TRUE, add = TRUE)

par(mar = rep(0,4), oma = rep(0,4), pty = "s")
plot(tr[["res"]]$sample_count, col = viridis::mako(100, alpha = 1.0), axes = FALSE, box = TRUE, legend = TRUE)
plot(tr_k$sample_count, col = viridis::mako(100), axes = FALSE, box = TRUE, legend = FALSE)

```

# Comparison of measures

```{r, fig.width = 6, fig.height = 8}
msk_lyr <- get_divout(file.name = "rr", rarify = TRUE, measure = "pi")
measures <- c("pi", "biallelic_richness", "heterozygosity")
datasets <- c("rr", "WGS", "FULL")

for(m in measures){
  par(mfrow = c(3, 2), mar = rep(2,4))
  for(d in datasets){
    for(rarify in c("TRUE", "FALSE")){
      r <- get_divout(file.name = d, rarify, measure = m)
      r <- mask(r, msk_lyr)
      if(m == "pi"){zlim = c(0.1,0.5)}
      if(m == "biallelic_richness"){zlim = c(1.1,2)}
      if(m == "heterozygosity"){zlim = c(0.3,0.5)}
      plot(r,  col = magma(100), box = FALSE, axes = FALSE, main = paste(d, m, rarify), zlim = zlim)          
    }
  }
}


```

```{r, fig.width = 7.5, fig.height = 5}
for(m in measures){
  par(mfrow = c(2, 3), mar = c(1,0,1,0), oma = rep(0,4))
  for(rarify in c("TRUE", "FALSE")){
    for(d in datasets){
      r <- get_divout(file.name = d, rarify, measure = m)
      r <- mask(r, msk_lyr)
      if(m == "pi"){zlim = c(0.1,0.5)}
      if(m == "biallelic_richness"){zlim = c(1.1,2)}
      if(m == "heterozygosity"){zlim = c(0.3,0.5)}
       plot(lyr, col = magma(1, begin = 0.1, alpha = 0.1), axes = FALSE, box = TRUE, zlim = c(0.01,1), legend = FALSE)
      plot(r,  col = magma(100), box = TRUE, axes = FALSE, main = "", zlim = zlim, legend = FALSE, add = TRUE)          
    }
  }
}
```

```{r, fig.width = 7.5, fig.height = 5}
for(m in measures){
  par(mfrow = c(2, 3), mar = c(1,0,1,0), oma = rep(0,4))
  for(rarify in c("TRUE", "FALSE")){
    for(d in datasets){
      r <- get_divout(file.name = d, rarify, measure = m)
      r <- scale(r)
      r <- mask(r, msk_lyr)
      plot(lyr, col = magma(1, begin = 0.1, alpha = 0.1), axes = FALSE, zlim = c(0.01,1), box = TRUE, legend = FALSE)
      plot(r,  col = magma(100), box = TRUE, axes = FALSE, main = "", legend = FALSE, add = TRUE)          
    }
  }
}


```

```{r}
# demonstrate that allelic richness and biallelic richness are the same 
wgs_ar <- stack("outputs/WGS_200ind_allelic_richness.tif")[[1]]

wgs_bar <- stack("outputs/WGS_200ind_biallelic_richness.tif")[[1]]

par(mfrow = c(1,2))
lapply(list(wgs_bar, wgs_ar), raster::plot, col = magma(100), box = FALSE, axes = FALSE)

```

## Timing
```{r}

tdf <- dplyr::bind_rows(
  map_dfr(c("rr", "WGS", "FULL"), get_timeout, rarify = "TRUE", parallel = "FALSE"),
  map_dfr(c("rr", "WGS", "FULL"), get_timeout, rarify = "FALSE", parallel = "FALSE"),
  map_dfr(c("rr", "WGS", "FULL"), get_timeout, rarify = "TRUE", parallel = "TRUE"),
  map_dfr(c("rr", "WGS", "FULL"), get_timeout, rarify = "FALSE", parallel = "TRUE")
)

ggplot(data = tdf[tdf$parallel == "TRUE",]) +
  geom_bar(aes(x = dataset, y = time, fill = stat), stat = "identity", position=position_dodge()) +
  facet_wrap(~rarify, nrow = 1)

ggplot(data = tdf[tdf$parallel == "FALSE",]) +
  geom_bar(aes(x = dataset, y = time, fill = stat), stat = "identity", position=position_dodge()) +
  facet_wrap(~rarify, nrow = 1)  


tdf <- dplyr::bind_rows(
  map_dfr(c("rr", "WGS", "FULL"), get_timeout, rarify = "TRUE", parallel = "FALSE"),
  map_dfr(c("rr", "WGS", "FULL"), get_timeout, rarify = "TRUE", parallel = "TRUE")
)

tdf[tdf$rarify == "TRUE", c("time", "dataset")]

ggplot(data = tdf[tdf$parallel == "TRUE",]) +
  geom_bar(aes(x = dataset, y = time, fill = stat), stat = "identity", position=position_dodge()) 
ggplot(data = tdf[tdf$parallel == "FALSE",]) +
  geom_bar(aes(x = dataset, y = time, fill = stat), stat = "identity", position=position_dodge()) 
```

```{r}
load("RData/ar_results.RData")

```

# IGNORE BELOW THIS LINE - RAREFACTION STUFF --------------------------------------------------------

```{r, fig.width = 5, fig.height = 5}
cores <- 6
cl <- makeCluster(cores)
registerDoParallel(cl)

stk <- list()

i = 1
for(f in c(3, 5, 7)){
  for(w in c(3, 5, 7)){
    res <- window_gd(subvcf, subcoords, lyr, stat = "pi", fact = f, wdim = w, rarify = TRUE, rarify_n = 4, rarify_nit = 5, parallel = TRUE, nloci = nrow(subvcf@gt))
    stk[[i]] <-  res[[1]]
    plot(res[[1]], col = magma(100))
    i <- i + 1
  }
}

i = 1
par(mfrow = c(3,3), mar = rep(0,4), oma = rep(0,4), pty = "s")
for(f in c(3, 5, 7)){
  for(w in c(3, 5, 7)){
    plot(lyr, col = magma(1, begin = 0.1, alpha = 0.1), axes = FALSE, box = FALSE, zlim = c(0.01,1), legend = FALSE)
    plot(stk[[i]], col = magma(100), axes = FALSE, box = FALSE, legend = FALSE, zlim = c(0.23, 0.48), add = TRUE)
    rect(0, -105, 100, 0, border = "black")
    i <- i + 1
  }
}
plot(stk[[1]], zlim = c(0.23, 0.48), col = magma(100) )
```

## ADD FOR LOOP TEST OF FACT VS WINDOW SIZE

```{r, fig.width = 4, fig.height = 4}
set.seed(42)

resf <- purrr::map(c(2, 4, 8, 16), time_test, "fact", subvcf, subcoords, lyr, stat = "pi", wdim = 5, rarify = TRUE, rarify_n = 10, rarify_nit = 10)

plot_time_test(resf, stat = "fact")
plot_time_test(resf, stat = "ncell")
plot_time_test(resf, stat = "total_count")
```

```{r, fig.width = 10, fig.height = 5}
plot_rast_test(resf)
```

```{r, fig.width = 16, fig.height = 4}
set.seed(42)

resw <- purrr::map(c(3, 5, 7, 9, 11), time_test, "wdim", subvcf, subcoords, lyr, fact = 3, stat = "pi", rarify = TRUE, rarify_n = 4, rarify_nit = 5)

plot_time_test(resw)

resw <- purrr::map(c(3, 5, 7, 9, 11), time_test, "wdim", subvcf, subcoords, lyr, fact = 5, stat = "pi", rarify = TRUE, rarify_n = 4, rarify_nit = 5)

plot_time_test(resw)

```

```{r, fig.width = 10, fig.height = 4}
plot_rast_test(resw)
```

```{r, fig.width = 16, fig.height = 4}
set.seed(42)

resfr <- purrr::map(c(2, 4, 8, 16), time_test, "fact", subvcf, subcoords, lyr, stat = "pi", wdim = 5, rarify = FALSE, min_n = 10)

plot_time_test(resfr)

```

```{r, fig.width = 10, fig.height = 4}
plot_rast_test(resfr)
```

```{r, fig.width = 16, fig.height = 4}
set.seed(42)

reswr <- purrr::map(c(5, 7, 9, 11, 13), time_test, "wdim", subvcf, subcoords, lyr, fact = 4, stat = "pi", rarify = FALSE, min_n = 10)

plot_time_test(reswr)

```
# REALIZATION: TIME CHANGING MIGHT HAVE TO DO WITH EDGE OF LANDSCAPE, NOT WINDOW SIZE EXACLTY - MAY NEED TO TRY FAKE LANDSCAPE WITH PERFECT EVEN SAMPLING TO GET CALCS RIGHT
(replicate the vcf from one individual multiple times evenly across a landscape, also check if there is a diff based on the value but there shouldn't be)

# UNIFORM GRID
```{r, fig.width = 5, fig.height=5}
m <- matrix(1, ncol = 10, nrow = 10)
r <- raster(m)
pts <- rasterToPoints(r)
dcoords <- data.frame(pts[,c("x","y")])
dvcf <- vcf[1:10000,c(1, sample(nrow(dcoords)) + 1)]

dr <- raster(matrix(1,ncol = 10, nrow = 10))

par(pty ="s")
ncell(dr) == nrow(dcoords)
plot(dr)
points(dcoords)
```
note: rarify_n needs to be 2 so that landscape/sampling doesn't affect the results (e.g. you don't want any NA values)
```{r}
dr100 <- raster(matrix(1, ncol = 100, nrow = 100))
resf <- purrr::map(c(2, 3, 5, 10, 20), time_test, "fact", dvcf, dcoords, dr100, stat = "pi", wdim = 5, rarify = TRUE, rarify_n = 2, rarify_nit = 2, min_n = 2)

plot_time_test(resf, stat = "total_count")
```
# FIGURE OUT THIS WEIRDNESS:
```{r}
resf <- purrr::map(c(3, 5, 7, 9), time_test, "wdim", dvcf, dcoords, dr, stat = "pi", fact = 1, rarify = TRUE, rarify_n = 2, rarify_nit = 2)
plot_time_test(resf, stat = "wsize")
plot_time_test(resf)
```

note to self: I don't think I am counting total time right still...need to think on it (check the minutes versus seconds calculations)


# Rarefaction test

```{r}
m <- matrix(1, ncol = 10, nrow = 20)
r1 <- raster(m)
extent(r1) <- c(0, 10, 0, 20)
m <- matrix(2, ncol = 10, nrow = 20)
r2 <- raster(m)
r2 <- aggregate(r2, 2)
extent(r2) <- c(10, 20, 0, 20)
pts <- rbind(rasterToPoints(r1), rasterToPoints(r2))


dcoords <- data.frame(pts[,c("x","y")])
plot(dcoords)
dvcf <- vcf[1:10000,c(1, sample(nrow(dcoords)) + 1)]

dr <- raster(matrix(1, ncol = 20, nrow = 20))
extent(dr) <- c(0,20,0,20)
par(pty ="s")
plot(dr)
points(dcoords)

wr <- sim(dvcf, dcoords, dr, stat = "het", fact = 0, wdim = 7, min_n = 6, rarify = FALSE, parallel = TRUE)

wor <- sim(dvcf, dcoords, dr, stat = "het", fact = 0, wdim = 7, rarify = TRUE, rarify_n = 6, rarify_nit = 10, parallel = TRUE)

plot(wr$res[[1]], zlim = c(4029, 4829.786), col = magma(100))
plot(wor$res[[1]], zlim = c(4029, 4829.786), col = magma(100))

par(mfrow = c(1,2))
plot(wr$res[[1]], zlim = c(0, 0.5), col = magma(100), main = "No Rarefaction")
plot(wor$res[[1]], zlim = c(0, 0.5), col = magma(100), main = "Rarefaction")
```



#Rarefaction take 2
```{r}
SiteSampleBuffer <- function(sample_sites, coords, npts, buffer_size = 5){
  #sample_sites - coordinates of sampling sites
  #coords - coordinates of all individuals in data set
  #npts - number of points to sample from each site
  #buffer - buffer around site from which to draw samples randomly
  #edge_buffer - buffer from landscape edges to prevent sampling of sites
  
  site_samples <- data.frame()
  
  #sample sites can be provided as either sp or coords in vector format (nloop just counts how many sites)
  if(class(sample_sites)[1] == "SpatialPoints"){nloop <- length(sample_sites)} else {nloop <- nrow(sample_sites)}
  
  for(s in 1:nloop){
    #create buffer around sites from which to sample points
    site_buffers <- rgeos::gBuffer(sample_sites[s,], width = buffer_size)
    #subset out only coordinates falling within site buffers
    buffer_samples <- coords[site_buffers,]
    if(length(buffer_samples) < npts){stop(paste0("Less than npts found in buffer around site"))}
    #convert from SPDF to df
    buffer_samples_df <- data.frame(buffer_samples)
    #randomly sample samples from coordinates
    randsamp <- sample(nrow(buffer_samples_df), npts)
    #subset df
    buffer_samples_df <- buffer_samples_df[randsamp,]
    
    #save site IDs
    buffer_samples_df$site <- s
    
    #bind samples
    site_samples <- rbind(site_samples, buffer_samples_df)
  }
  return(site_samples[,c("idx", "x", "y")])
}
```

```{r}

plot(lyr)
points(coords)

pts <- coords
coordinates(pts) <- ~x+y

sample_sites <- rbind.data.frame(c(75, -20), c(25, -20), c(50, -20))
colnames(sample_sites) <- c("x", "y")
coordinates(sample_sites) <- ~x+y


subcoords <- rbind.data.frame(SiteSampleBuffer(sample_sites[3], pts, npts = 5, buffer_size = 10),
                              SiteSampleBuffer(sample_sites[2], pts, npts = 20, buffer_size = 10))


plot(lyr)
points(subcoords[,c("x","y")])


si <- colnames(vcf@gt) %in% subcoords$idx
si[1] <- TRUE
subvcf <- vcf[l, si]

# reorder coords to match
subcoords <- subcoords[match(colnames(subvcf@gt[,-1]), subcoords$idx),]
 
# check match
all(colnames(subvcf@gt)[-1] == as.character(subcoords$idx))

nr <- window_gd(subvcf, subcoords[,c("x","y")], lyr, "biallelic.richness", fact = 3, wdim = 5, rarify = FALSE, min_n = 4, nloci = nrow(subvcf@gt))
yr <- window_gd(subvcf, subcoords[,c("x","y")], lyr, "biallelic.richness", fact = 3, wdim = 5, rarify = TRUE, rarify_n = 4, rarify_nit = 5, nloci = nrow(subvcf@gt))
par(mfrow = c(1,3))
plot(nr[[1]], col = magma(100), zlim = c(1.170413, 1.999993))
plot(yr[[1]], col = magma(100), zlim = c(1.170413, 1.999993))
plot(mask(full_ar, nr)[[1]], col = magma(100), zlim = c(1.170413, 1.999993))

par(mfrow = c(1,3))
plot(nr[[1]], col = magma(100))
plot(yr[[1]], col = magma(100))
plot(mask(full_ar, nr)[[1]], col = magma(100))
```


