---
title: "wingen-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{wingen-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "##",
  background = "#FFFFFF"
)
```

```{r setup, warning = FALSE, message = FALSE}
library(wingen)
library(raster)
library(vcfR)
library(viridis)
library(foreach)
library(doParallel)
```

# Load middle earth example

The middle earth example dataset contains three objects which are loaded by 'load_middle_earth_ex()' [Add more detail about this simulation here] 

```{r load example data, fig.width = 5, fig.height = 5}
load_middle_earth_ex()

# Genetic data
vcf

# Coordinates
head(coords)

# Raster data
lyr

# Map of data
plot(lyr, col = magma(100), axes = FALSE, box = FALSE)
points(coords, col = mako(1, begin = 0.8), pch = 3, cex = 0.5)
```

# Main functions

## Run sliding window calculations

```{r sliding window, fig.width = 5, fig.height = 5, cache = TRUE}
wgd <- window_gd(vcf,
          coords,
          lyr,
          stat = "pi",
          fact = 3,
          wdim = 5,
          rarify = TRUE,
          nloci = 1000)


plot_gd(wgd, main = "Window pi")
plot_count(wgd, main = "Window sample counts")
```

## Krige results

```{r krige results, fig.width = 5, fig.height = 5, cache = TRUE}
kgd <- krig_gd(wgd, lyr, resample = FALSE)

plot_gd(kgd, main = "Kriged pi")
plot_count(kgd, main = "Kriged sample counts")
```

## Mask results

```{r mask results, fig.width = 5, fig.height = 5}
mgd <- mask_gd(kgd, min_n = 3)

plot_gd(mgd, main = "Kriged & masked pi")
```


# Parallelization

```{r no parallelization}
system.time(wgd <- window_gd(vcf,
          coords,
          lyr,
          stat = "pi",
          fact = 3,
          wdim = 5,
          rarify = TRUE,
          nloci = 1000))
```

```{r parallelization, fig.width = 5, fig.height = 5}
cores <- 5
cl <- makeCluster(cores)
registerDoParallel(cl)

system.time(
wgd <- window_gd(vcf,
          coords,
          lyr,
          stat = "pi",
          fact = 3,
          wdim = 5,
          rarify = TRUE,
          nloci = 1000, 
          parallel = TRUE)
)

stopCluster(cl)
```

# Other genetic diversity metrics

```{r}
pi_wgd <- window_gd(vcf,
          coords,
          lyr,
          stat = "pi",
          fact = 3,
          wdim = 5,
          rarify = TRUE,
          nloci = 1000)

het_wgd <- window_gd(vcf,
          coords,
          lyr,
          stat = "het",
          fact = 3,
          wdim = 5,
          rarify = TRUE)

AR_wgd <- window_gd(vcf,
          coords,
          lyr,
          stat = "biallelic.richness",
          fact = 3,
          wdim = 5,
          rarify = TRUE)
```


```{r, fig.width = 5, fig.height = 5}
plot_gd(pi_wgd, main = "Pi")

plot_gd(het_wgd, main = "Heterozygosity")

plot_gd(AR_wgd, main = "Allelic Richness")
```

