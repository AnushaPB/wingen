---
title: "Wingen Vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{wingen-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "##",
  background = "#FFFFFF"
)

options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, warning = FALSE, message = FALSE}
library(wingen)
library(raster)
library(vcfR)
library(viridis)
library(foreach)
library(doParallel)

devtools::load_all()
```

```{r, fig.width = 5, fig.height = 5}
coords_file <- system.file("extdata", "ex_coords.csv", package = "wingen")
lyr_file <- system.file("extdata", "ex_layer.tif", package = "wingen")
vcf_file <- system.file("extdata", "ex_vcf.vcf", package = "wingen")

ex_lyr <- raster(lyr_file)
ex_coords <- read.csv(coords_file)
ex_vcf <- read.vcfR(vcf_file)

plot(ex_lyr, legend = FALSE, col = "gray", axes = FALSE, box = FALSE)
points(ex_coords)
```

```{r, fig.width = 8, fig.height=4}
# (for the sake of speed I am aggregating the raster by a factor of 50)
gdmap <- window_gd(ex_vcf, ex_coords, ex_lyr, stat = "pi", fact = 50, wdim = 5, rarify = FALSE)
plot(gdmap, col = magma(100), axes = FALSE)
```

```{r, fig.width = 8, fig.height=4}
# run window with rarefaction
gdmapr <- window_gd(ex_vcf, ex_coords, ex_lyr, stat = "pi", fact = 50, wdim = 5, rarify = TRUE,  rarify_n = 4, rarify_nit = 10)
plot(gdmapr, col = magma(100), axes = FALSE)
  
```

```{r, fig.width = 10, fig.height = 5}
krig_gdmapr <- krig_rast(gdmapr, disagg = 10)
plot(krig_gdmapr, col = viridis::magma(100), box = FALSE, axes = FALSE)

krig_gdmapr <- krig_rast(gdmapr, ex_lyr, agg = 5)
plot(krig_gdmapr, col = viridis::magma(100), box = FALSE, axes = FALSE)
```
```{r, fig.width = 5, fig.height=5}
krig_msk <- div_mask(gdmapr, 4)
plot(krig_msk, col = viridis::magma(100), box = FALSE, axes = FALSE)

krig_msk <- div_mask(krig_gdmapr, 4)
plot(krig_msk, col =  viridis::magma(100),  box = FALSE, axes = FALSE)
```

```{r, fig.width = 5, fig.height = 5}
krig_msk <- div_mask(krig_gdmapr, 4, plot = TRUE, bkg.col = "black")
```
# Different measures (with parallelization!)
```{r, fig.width = 9, fig.height=3, cache = TRUE}
cores <- 6
cl <- makeCluster(cores)
registerDoParallel(cl)

wind_het <- window_gd(ex_vcf, ex_coords, ex_lyr, stat = "het", fact = 50, wdim = 5, rarify = TRUE,  rarify_n = 4, rarify_nit = 10)
wind_pi <- window_gd(ex_vcf, ex_coords, ex_lyr, stat = "pi", fact = 50, wdim = 5, rarify = TRUE,  rarify_n = 4, rarify_nit = 10)
#wind_ar <- window_gd(ex_vcf, ex_coords, ex_lyr, stat = "allelic.richness", fact = 50, wdim = 5, rarify = TRUE,  rarify_n = 4, rarify_nit = 10)

stopCluster(cl)

par(mfrow = c(1,3))
#plot(wind_ar[[1]], col = magma(100), axes = FALSE)
plot(wind_het[[1]], col = magma(100), axes = FALSE)
plot(wind_pi[[1]], col = magma(100), axes = FALSE)
```
```{r fig.width = 9, fig.height=3}
#gd_stack <- stack(wind_ar, wind_het, wind_pi)
gd_stack <- stack(wind_het, wind_pi)
gd_krig <- krig_rast(gd_stack, ex_lyr, agg = 5)

par(mfrow = c(1,3))
gd_mask <- div_mask(gd_krig, 4, plot = TRUE, bkg.col = "black")
```
